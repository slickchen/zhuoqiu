<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>玩家对战记录系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #0f4c75;
        }

        h1 {
            color: #4cc9f0;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #a9a9a9;
            font-size: 1.1rem;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .section {
            background-color: #162447;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .section-title {
            color: #4cc9f0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #0f4c75;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 1.2rem;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background-color: #1f4068;
            border: 2px solid #0f4c75;
            color: #e6e6e6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background-color: #0f4c75;
        }

        .mode-btn.active {
            background-color: #4cc9f0;
            color: #1a1a2e;
            border-color: #4cc9f0;
        }

        .team-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .team {
            background-color: #1f4068;
            padding: 15px;
            border-radius: 8px;
        }

        .team-title {
            color: #fca311;
            margin-bottom: 10px;
            font-weight: 600;
        }

        select {
            width: 100%;
            padding: 10px;
            background-color: #0f3460;
            color: #e6e6e6;
            border: 1px solid #4cc9f0;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #a9a9a9;
        }

        .defeat-selector {
            display: flex;
            gap: 15px;
        }

        .defeat-option {
            flex: 1;
            padding: 12px;
            background-color: #1f4068;
            border: 2px solid #0f4c75;
            color: #e6e6e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .defeat-option:hover {
            background-color: #0f4c75;
        }

        .defeat-option.selected {
            background-color: #e63946;
            border-color: #e63946;
        }

        .input-note {
            width: 100%;
            padding: 10px;
            background-color: #0f3460;
            color: #e6e6e6;
            border: 1px solid #4cc9f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .char-count {
            text-align: right;
            font-size: 0.8rem;
            color: #a9a9a9;
            margin-top: 5px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: #2ab7e9;
            transform: translateY(-2px);
        }

        .btn-share {
            background-color: #2ecc71;
            margin-top: 15px;
        }

        .btn-share:hover {
            background-color: #27ae60;
        }

        .btn-clear {
            background-color: #e63946;
            margin-top: 10px;
        }

        .btn-clear:hover {
            background-color: #d32f2f;
        }

        .btn-generate {
            background-color: #9b59b6;
            margin-top: 10px;
        }

        .btn-generate:hover {
            background-color: #8e44ad;
        }

        .player-list {
            list-style: none;
            margin-top: 15px;
        }

        .player-item {
            background-color: #1f4068;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: 600;
        }

        .player-type {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: #0f4c75;
        }

        .player-type.fixed {
            background-color: #4cc9f0;
            color: #1a1a2e;
        }

        .player-type.custom {
            background-color: #fca311;
            color: #1a1a2e;
        }

        .custom-player-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .custom-player-input input {
            flex: 1;
            padding: 10px;
            background-color: #0f3460;
            color: #e6e6e6;
            border: 1px solid #4cc9f0;
            border-radius: 6px;
        }

        .custom-player-input button {
            padding: 10px 20px;
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .history-item {
            background-color: #1f4068;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 5px solid #4cc9f0;
            position: relative;
        }

        .delete-history-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            color: #e63946;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .delete-history-btn:hover {
            background-color: rgba(230, 57, 70, 0.2);
            transform: scale(1.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #fca311;
            font-weight: 600;
            padding-right: 30px;
        }

        .history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
        }

        .history-note {
            margin-top: 10px;
            padding: 8px;
            background-color: #0f3460;
            border-radius: 4px;
            font-style: italic;
        }

        .empty-history {
            text-align: center;
            padding: 30px;
            color: #a9a9a9;
            font-style: italic;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-controls .btn {
            margin-top: 0;
            flex: 1;
            min-width: 150px;
        }

        .history-count {
            text-align: center;
            margin-bottom: 15px;
            color: #a9a9a9;
            font-size: 0.9rem;
        }

        .share-section {
            background-color: #1f4068;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .share-link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .share-link {
            flex: 1;
            padding: 10px;
            background-color: #0f3460;
            color: #e6e6e6;
            border: 1px solid #4cc9f0;
            border-radius: 6px;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .copy-btn {
            padding: 10px 15px;
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background-color: #2ab7e9;
        }

        .qrcode-container {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            display: inline-block;
        }

        .qrcode-label {
            margin-bottom: 10px;
            color: #1a1a2e;
            font-weight: 600;
        }

        .share-info {
            margin-top: 15px;
            color: #a9a9a9;
            font-size: 0.9rem;
            text-align: center;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background-color: #162447;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            color: #4cc9f0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        .modal-content {
            color: #e6e6e6;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background-color: #e63946;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #d32f2f;
        }

        .modal-btn.cancel {
            background-color: #4cc9f0;
            color: #1a1a2e;
        }

        .modal-btn.cancel:hover {
            background-color: #2ab7e9;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #0f4c75;
            color: #a9a9a9;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .mode-selector, .defeat-selector {
                flex-direction: column;
            }
            
            .history-controls {
                flex-direction: column;
            }
            
            .share-link-container {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-gamepad"></i> 玩家对战记录系统</h1>
        <p class="subtitle">支持1v1 / 2v2对战模式，记录战败方及备注信息</p>
    </header>

    <div class="container">
        <div class="section">
            <h2 class="section-title"><i class="fas fa-cogs"></i> 对战设置</h2>
            
            <div class="mode-selector">
                <div class="mode-btn active" id="mode1v1">1V1 对战</div>
                <div class="mode-btn" id="mode2v2">2V2 对战</div>
            </div>
            
            <div class="team-container">
                <div class="team" id="teamA">
                    <div class="team-title">A 队</div>
                    <select id="playerA1">
                        <option value="">选择玩家1</option>
                    </select>
                    <select id="playerA2" style="display: none;">
                        <option value="">选择玩家2</option>
                    </select>
                </div>
                
                <div class="team" id="teamB">
                    <div class="team-title">B 队</div>
                    <select id="playerB1">
                        <option value="">选择玩家1</option>
                    </select>
                    <select id="playerB2" style="display: none;">
                        <option value="">选择玩家2</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">选择战败方：</label>
                <div class="defeat-selector">
                    <div class="defeat-option" id="defeatA">A队</div>
                    <div class="defeat-option" id="defeatB">B队</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">战败备注（仅支持大写字母 A-Z）：</label>
                <input type="text" class="input-note" id="battleNote" placeholder="例：A、B、WIN、LOSE 等" maxlength="10">
                <div class="char-count">仅支持大写英文字母（A-Z），最多10个字符</div>
            </div>
            
            <button class="btn" id="recordBattle">
                <i class="fas fa-save"></i> 记录对战结果
            </button>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fas fa-users"></i> 玩家管理（共10位）</h2>
            
            <h3>固定玩家（7位，不可修改）：</h3>
            <ul class="player-list" id="fixedPlayers"></ul>
            
            <h3>自定义玩家（3位，可修改）：</h3>
            <ul class="player-list" id="customPlayers"></ul>
            
            <div class="custom-player-input">
                <input type="text" id="customPlayerInput" placeholder="输入自定义玩家名称">
                <button id="saveCustomPlayer">保存</button>
            </div>
            
            <h3 style="margin-top: 20px;">所有可用玩家（10位）：</h3>
            <ul class="player-list" id="allPlayers"></ul>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fas fa-history"></i> 对战历史记录</h2>
            
            <div class="history-controls">
                <button class="btn btn-share" id="saveAsImage">
                    <i class="fas fa-image"></i> 保存为图片
                </button>
                <button class="btn btn-share" id="shareWechat">
                    <i class="fab fa-weixin"></i> 分享到微信
                </button>
                <button class="btn btn-generate" id="generateShare">
                    <i class="fas fa-share-alt"></i> 生成共享链接
                </button>
            </div>
            
            <button class="btn btn-clear" id="clearHistory">
                <i class="fas fa-trash-alt"></i> 清除所有记录
            </button>
            
            <div class="history-count" id="historyCount">当前共有 0 条对战记录</div>
            
            <!-- 共享链接区域 -->
            <div class="share-section" id="shareSection" style="display: none;">
                <h3 style="color: #fca311; margin-bottom: 15px;">
                    <i class="fas fa-link"></i> 共享对战记录
                </h3>
                <div class="share-link-container">
                    <input type="text" class="share-link" id="shareLink" readonly>
                    <button class="copy-btn" id="copyLinkBtn">
                        <i class="far fa-copy"></i> 复制链接
                    </button>
                </div>
                <div style="text-align: center;">
                    <div id="qrcode"></div>
                </div>
                <div class="share-info">
                    <p><i class="fas fa-info-circle"></i> 将此链接或二维码分享给其他人，他们可以查看完整的对战历史记录</p>
                    <p>链接有效期：永久有效（数据存储在本地）</p>
                </div>
            </div>
            
            <div id="historyList">
                <div class="empty-history">
                    <i class="fas fa-history fa-2x" style="margin-bottom: 15px;"></i>
                    <p>暂无对战记录</p>
                    <p>请开始记录对战</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认清除模态框 -->
    <div class="modal-overlay" id="clearConfirmModal">
        <div class="modal">
            <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> 确认清除</h3>
            <div class="modal-content" id="clearConfirmMessage">
                确定要清除所有对战记录吗？此操作不可撤销！
            </div>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="confirmClear">确定清除</button>
                <button class="modal-btn cancel" id="cancelClear">取消</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>玩家对战记录系统 &copy; 2023 | 支持1v1 / 2v2对战模式，10位玩家管理 | 支持共享对战记录</p>
    </footer>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // 初始固定玩家列表 - 指定的7位玩家
        const fixedPlayers = [
            "第一陈", 
            "斯提芬饭", 
            "低质量黎", 
            "复愁满伍", 
            "鬼仔关", 
            "十二生肖", 
            "老王子米高"
        ];
        
        // 初始自定义玩家列表
        let customPlayers = ["自定义1", "自定义2", "自定义3"];
        
        // 对战历史记录
        let battleHistory = [];
        
        // 共享链接
        let shareLink = '';
        let qrcode = null;
        
        // DOM元素
        const mode1v1Btn = document.getElementById('mode1v1');
        const mode2v2Btn = document.getElementById('mode2v2');
        const playerA2Select = document.getElementById('playerA2');
        const playerB2Select = document.getElementById('playerB2');
        const defeatAOption = document.getElementById('defeatA');
        const defeatBOption = document.getElementById('defeatB');
        const battleNoteInput = document.getElementById('battleNote');
        const recordBattleBtn = document.getElementById('recordBattle');
        const fixedPlayersList = document.getElementById('fixedPlayers');
        const customPlayersList = document.getElementById('customPlayers');
        const allPlayersList = document.getElementById('allPlayers');
        const customPlayerInput = document.getElementById('customPlayerInput');
        const saveCustomPlayerBtn = document.getElementById('saveCustomPlayer');
        const historyList = document.getElementById('historyList');
        const saveAsImageBtn = document.getElementById('saveAsImage');
        const shareWechatBtn = document.getElementById('shareWechat');
        const generateShareBtn = document.getElementById('generateShare');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const clearConfirmModal = document.getElementById('clearConfirmModal');
        const clearConfirmMessage = document.getElementById('clearConfirmMessage');
        const confirmClearBtn = document.getElementById('confirmClear');
        const cancelClearBtn = document.getElementById('cancelClear');
        const historyCount = document.getElementById('historyCount');
        const shareSection = document.getElementById('shareSection');
        const shareLinkInput = document.getElementById('shareLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const qrcodeContainer = document.getElementById('qrcode');
        
        // 初始化页面
        function initPage() {
            // 从本地存储加载数据
            loadFromLocalStorage();
            
            // 初始化玩家选择下拉菜单
            initPlayerSelects();
            
            // 初始化玩家列表显示
            renderPlayerLists();
            
            // 设置默认对战模式
            setMode('1v1');
            
            // 检查URL参数，查看是否是从共享链接访问
            checkUrlParams();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 渲染历史记录
            renderHistory();
            
            // 更新历史记录计数
            updateHistoryCount();
        }
        
        // 从本地存储加载数据
        function loadFromLocalStorage() {
            const savedCustomPlayers = localStorage.getItem('customPlayers');
            const savedBattleHistory = localStorage.getItem('battleHistory');
            
            if (savedCustomPlayers) {
                customPlayers = JSON.parse(savedCustomPlayers);
            }
            
            if (savedBattleHistory) {
                battleHistory = JSON.parse(savedBattleHistory);
            }
        }
        
        // 检查URL参数
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            
            if (sharedData) {
                try {
                    // 解码Base64数据
                    const decodedData = atob(sharedData);
                    const sharedHistory = JSON.parse(decodedData);
                    
                    if (Array.isArray(sharedHistory) && sharedHistory.length > 0) {
                        // 显示共享的历史记录
                        displaySharedHistory(sharedHistory);
                        return true;
                    }
                } catch (e) {
                    console.error('解析共享数据失败:', e);
                }
            }
            return false;
        }
        
        // 显示共享的历史记录
        function displaySharedHistory(sharedHistory) {
            // 创建共享视图
            let historyHTML = '<div style="margin-bottom: 20px; padding: 15px; background-color: #2ecc71; border-radius: 8px; color: white;">';
            historyHTML += '<h3><i class="fas fa-share-alt"></i> 共享对战记录视图</h3>';
            historyHTML += '<p>您正在查看共享的对战记录。此视图为只读模式。</p>';
            historyHTML += '</div>';
            
            if (sharedHistory.length === 0) {
                historyHTML += `
                    <div class="empty-history">
                        <i class="fas fa-history fa-2x" style="margin-bottom: 15px;"></i>
                        <p>共享的对战记录为空</p>
                    </div>
                `;
            } else {
                sharedHistory.forEach((record, index) => {
                    const teamAText = record.teamA.join(' & ');
                    const teamBText = record.teamB.join(' & ');
                    
                    historyHTML += `
                        <div class="history-item">
                            <div class="history-header">
                                <span>${record.mode === '1v1' ? '1V1 对战' : '2V2 对战'} (#${index + 1})</span>
                                <span>${record.timestamp}</span>
                            </div>
                            <div class="history-details">
                                <div><strong>A队：</strong> ${teamAText}</div>
                                <div><strong>B队：</strong> ${teamBText}</div>
                                <div><strong>战败方：</strong> <span style="color: #e63946;">${record.defeatedTeam}队</span></div>
                            </div>
                            ${record.note ? `<div class="history-note"><strong>备注：</strong> ${record.note}</div>` : ''}
                        </div>
                    `;
                });
                
                historyCount.textContent = `共享记录：共 ${sharedHistory.length} 条对战记录`;
                historyCount.style.display = 'block';
            }
            
            historyList.innerHTML = historyHTML;
            
            // 隐藏编辑功能按钮，因为是只读视图
            document.querySelector('.history-controls').style.display = 'none';
            document.getElementById('clearHistory').style.display = 'none';
            document.getElementById('recordBattle').style.display = 'none';
            
            // 添加返回按钮
            const backButton = document.createElement('button');
            backButton.className = 'btn';
            backButton.style.marginTop = '20px';
            backButton.innerHTML = '<i class="fas fa-arrow-left"></i> 返回主页面';
            backButton.onclick = () => {
                window.location.href = window.location.pathname;
            };
            historyList.parentNode.insertBefore(backButton, historyList.nextSibling);
        }
        
        // 初始化玩家选择下拉菜单
        function initPlayerSelects() {
            const allPlayers = [...fixedPlayers, ...customPlayers];
            const playerSelects = [
                document.getElementById('playerA1'),
                document.getElementById('playerA2'),
                document.getElementById('playerB1'),
                document.getElementById('playerB2')
            ];
            
            // 清空所有选项（除了第一个占位选项）
            playerSelects.forEach(select => {
                while (select.options.length > 1) {
                    select.remove(1);
                }
            });
            
            // 添加玩家选项
            allPlayers.forEach(player => {
                playerSelects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    select.appendChild(option);
                });
            });
            
            // 设置默认选择
            if (allPlayers.length >= 2) {
                document.getElementById('playerA1').value = allPlayers[0];
                document.getElementById('playerB1').value = allPlayers[1];
            }
        }
        
        // 渲染玩家列表
        function renderPlayerLists() {
            // 清空列表
            fixedPlayersList.innerHTML = '';
            customPlayersList.innerHTML = '';
            allPlayersList.innerHTML = '';
            
            // 渲染固定玩家
            fixedPlayers.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `
                    <div>
                        <span style="color: #a9a9a9; margin-right: 8px;">${index + 1}.</span>
                        <span class="player-name">${player}</span>
                    </div>
                    <span class="player-type fixed">固定</span>
                `;
                fixedPlayersList.appendChild(li);
            });
            
            // 渲染自定义玩家
            customPlayers.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `
                    <div>
                        <span style="color: #a9a9a9; margin-right: 8px;">${index + 8}.</span>
                        <span class="player-name">${player}</span>
                    </div>
                    <span class="player-type custom">自定义</span>
                `;
                customPlayersList.appendChild(li);
            });
            
            // 渲染所有玩家
            const allPlayers = [...fixedPlayers, ...customPlayers];
            allPlayers.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                
                const playerType = index < fixedPlayers.length ? 
                    `<span class="player-type fixed">固定</span>` : 
                    `<span class="player-type custom">自定义</span>`;
                
                li.innerHTML = `
                    <div>
                        <span style="color: #a9a9a9; margin-right: 8px;">${index + 1}.</span>
                        <span class="player-name">${player}</span>
                    </div>
                    ${playerType}
                `;
                allPlayersList.appendChild(li);
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 模式切换
            mode1v1Btn.addEventListener('click', () => setMode('1v1'));
            mode2v2Btn.addEventListener('click', () => setMode('2v2'));
            
            // 战败方选择
            defeatAOption.addEventListener('click', () => selectDefeat('A'));
            defeatBOption.addEventListener('click', () => selectDefeat('B'));
            
            // 记录对战结果
            recordBattleBtn.addEventListener('click', recordBattle);
            
            // 保存自定义玩家
            saveCustomPlayerBtn.addEventListener('click', saveCustomPlayer);
            customPlayerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCustomPlayer();
                }
            });
            
            // 保存为图片
            saveAsImageBtn.addEventListener('click', saveAsImage);
            
            // 分享到微信
            shareWechatBtn.addEventListener('click', shareToWechat);
            
            // 生成共享链接
            generateShareBtn.addEventListener('click', generateShareLink);
            
            // 复制链接
            copyLinkBtn.addEventListener('click', copyShareLink);
            
            // 清除历史记录
            clearHistoryBtn.addEventListener('click', showClearConfirm);
            confirmClearBtn.addEventListener('click', clearAllHistory);
            cancelClearBtn.addEventListener('click', hideClearConfirm);
            
            // 备注输入限制
            battleNoteInput.addEventListener('input', validateNoteInput);
            
            // 点击模态框外部关闭
            clearConfirmModal.addEventListener('click', (e) => {
                if (e.target === clearConfirmModal) {
                    hideClearConfirm();
                }
            });
        }
        
        // 设置对战模式
        function setMode(mode) {
            if (mode === '1v1') {
                mode1v1Btn.classList.add('active');
                mode2v2Btn.classList.remove('active');
                playerA2Select.style.display = 'none';
                playerB2Select.style.display = 'none';
            } else {
                mode1v1Btn.classList.remove('active');
                mode2v2Btn.classList.add('active');
                playerA2Select.style.display = 'block';
                playerB2Select.style.display = 'block';
            }
        }
        
        // 选择战败方
        function selectDefeat(team) {
            defeatAOption.classList.remove('selected');
            defeatBOption.classList.remove('selected');
            
            if (team === 'A') {
                defeatAOption.classList.add('selected');
            } else {
                defeatBOption.classList.add('selected');
            }
        }
        
        // 验证备注输入 - 只允许大写字母A-Z，不允许数字0-9
        function validateNoteInput() {
            let value = battleNoteInput.value;
            // 只允许大写字母A-Z，不允许数字
            value = value.replace(/[^A-Z]/g, '');
            battleNoteInput.value = value;
        }
        
        // 记录对战结果
        function recordBattle() {
            // 获取对战模式
            const mode = mode1v1Btn.classList.contains('active') ? '1v1' : '2v2';
            
            // 获取队伍成员
            const playerA1 = document.getElementById('playerA1').value;
            const playerA2 = mode === '2v2' ? document.getElementById('playerA2').value : '';
            const playerB1 = document.getElementById('playerB1').value;
            const playerB2 = mode === '2v2' ? document.getElementById('playerB2').value : '';
            
            // 验证必须选择的玩家
            if (!playerA1 || !playerB1 || (mode === '2v2' && (!playerA2 || !playerB2))) {
                alert('请选择所有玩家！');
                return;
            }
            
            // 检查是否有重复的玩家
            const players = [playerA1, playerA2, playerB1, playerB2].filter(p => p);
            const uniquePlayers = [...new Set(players)];
            if (players.length !== uniquePlayers.length) {
                alert('不能选择相同的玩家！');
                return;
            }
            
            // 获取战败方
            const defeatTeam = defeatAOption.classList.contains('selected') ? 'A' : 
                              defeatBOption.classList.contains('selected') ? 'B' : null;
            
            if (!defeatTeam) {
                alert('请选择战败方！');
                return;
            }
            
            // 获取备注并验证格式 - 只允许大写字母，不允许数字
            const note = battleNoteInput.value;
            // 验证备注只包含大写字母
            const notePattern = /^[A-Z]{0,10}$/;
            if (note && !notePattern.test(note)) {
                alert('备注只能包含大写字母（A-Z），最多10个字符！');
                return;
            }
            
            // 创建对战记录
            const battleRecord = {
                id: Date.now(),
                mode: mode,
                teamA: mode === '1v1' ? [playerA1] : [playerA1, playerA2],
                teamB: mode === '1v1' ? [playerB1] : [playerB1, playerB2],
                defeatedTeam: defeatTeam,
                note: note,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            // 添加到历史记录
            battleHistory.unshift(battleRecord);
            
            // 保存到本地存储
            saveToLocalStorage();
            
            // 渲染历史记录
            renderHistory();
            
            // 更新历史记录计数
            updateHistoryCount();
            
            // 重置表单
            battleNoteInput.value = '';
            defeatAOption.classList.remove('selected');
            defeatBOption.classList.remove('selected');
            
            // 显示成功消息
            alert('对战记录已保存！');
        }
        
        // 保存自定义玩家
        function saveCustomPlayer() {
            const playerName = customPlayerInput.value.trim();
            
            if (!playerName) {
                alert('请输入玩家名称！');
                return;
            }
            
            if (playerName.length > 10) {
                alert('玩家名称不能超过10个字符！');
                return;
            }
            
            // 查找空的自定义玩家位置
            const emptyIndex = customPlayers.findIndex(player => player.startsWith('自定义'));
            
            if (emptyIndex !== -1) {
                customPlayers[emptyIndex] = playerName;
            } else {
                // 如果所有自定义玩家位置都已满，替换第一个
                customPlayers[0] = playerName;
            }
            
            // 保存到本地存储
            saveToLocalStorage();
            
            // 更新玩家列表和选择下拉菜单
            renderPlayerLists();
            initPlayerSelects();
            
            // 清空输入框
            customPlayerInput.value = '';
            
            alert('自定义玩家已保存！');
        }
        
        // 渲染历史记录
        function renderHistory() {
            if (battleHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-history fa-2x" style="margin-bottom: 15px;"></i>
                        <p>暂无对战记录</p>
                        <p>请开始记录对战</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            battleHistory.forEach((record, index) => {
                const teamAText = record.teamA.join(' & ');
                const teamBText = record.teamB.join(' & ');
                
                historyHTML += `
                    <div class="history-item" data-id="${record.id}">
                        <button class="delete-history-btn" title="删除此记录" onclick="deleteSingleRecord(${record.id})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="history-header">
                            <span>${record.mode === '1v1' ? '1V1 对战' : '2V2 对战'} (#${index + 1})</span>
                            <span>${record.timestamp}</span>
                        </div>
                        <div class="history-details">
                            <div><strong>A队：</strong> ${teamAText}</div>
                            <div><strong>B队：</strong> ${teamBText}</div>
                            <div><strong>战败方：</strong> <span style="color: #e63946;">${record.defeatedTeam}队</span></div>
                        </div>
                        ${record.note ? `<div class="history-note"><strong>备注：</strong> ${record.note}</div>` : ''}
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }
        
        // 更新历史记录计数
        function updateHistoryCount() {
            const count = battleHistory.length;
            historyCount.textContent = `当前共有 ${count} 条对战记录`;
            historyCount.style.display = count > 0 ? 'block' : 'none';
        }
        
        // 删除单条记录
        function deleteSingleRecord(id) {
            if (confirm('确定要删除这条对战记录吗？')) {
                battleHistory = battleHistory.filter(record => record.id !== id);
                saveToLocalStorage();
                renderHistory();
                updateHistoryCount();
                alert('记录已删除！');
            }
        }
        
        // 显示清除确认模态框
        function showClearConfirm() {
            if (battleHistory.length === 0) {
                alert('当前没有对战记录可清除！');
                return;
            }
            
            clearConfirmMessage.textContent = `确定要清除所有 ${battleHistory.length} 条对战记录吗？此操作不可撤销！`;
            clearConfirmModal.style.display = 'flex';
        }
        
        // 隐藏清除确认模态框
        function hideClearConfirm() {
            clearConfirmModal.style.display = 'none';
        }
        
        // 清除所有历史记录
        function clearAllHistory() {
            battleHistory = [];
            saveToLocalStorage();
            renderHistory();
            updateHistoryCount();
            hideClearConfirm();
            alert('所有对战记录已清除！');
        }
        
        // 生成共享链接
        function generateShareLink() {
            if (battleHistory.length === 0) {
                alert('暂无对战记录可共享！');
                return;
            }
            
            // 创建共享数据
            const shareData = {
                history: battleHistory,
                players: {
                    fixed: fixedPlayers,
                    custom: customPlayers
                },
                generatedAt: new Date().toLocaleString('zh-CN'),
                totalRecords: battleHistory.length
            };
            
            // 将数据转换为Base64编码
            const jsonString = JSON.stringify(shareData);
            const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
            
            // 生成共享链接
            const currentUrl = window.location.origin + window.location.pathname;
            shareLink = `${currentUrl}?data=${base64Data}`;
            
            // 显示共享链接
            shareLinkInput.value = shareLink;
            shareSection.style.display = 'block';
            
            // 生成二维码
            generateQRCode();
            
            // 滚动到共享区域
            shareSection.scrollIntoView({ behavior: 'smooth' });
            
            alert('共享链接已生成！复制链接或扫描二维码与他人分享。');
        }
        
        // 生成二维码
        function generateQRCode() {
            // 清除之前的二维码
            qrcodeContainer.innerHTML = '';
            
            // 生成新的二维码
            qrcode = new QRCode(qrcodeContainer, {
                text: shareLink,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // 复制共享链接
        function copyShareLink() {
            if (!shareLink) {
                alert('请先生成共享链接！');
                return;
            }
            
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999); // 移动设备兼容
            
            try {
                navigator.clipboard.writeText(shareLink).then(() => {
                    // 复制成功反馈
                    const originalText = copyLinkBtn.innerHTML;
                    copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                    copyLinkBtn.style.backgroundColor = '#2ecc71';
                    
                    setTimeout(() => {
                        copyLinkBtn.innerHTML = originalText;
                        copyLinkBtn.style.backgroundColor = '';
                    }, 2000);
                    
                    alert('链接已复制到剪贴板！');
                }).catch(err => {
                    // 如果clipboard API失败，使用传统方法
                    document.execCommand('copy');
                    alert('链接已复制到剪贴板！');
                });
            } catch (err) {
                // 降级方案
                document.execCommand('copy');
                alert('链接已复制到剪贴板！');
            }
        }
        
        // 保存为图片
        function saveAsImage() {
            if (battleHistory.length === 0) {
                alert('暂无对战记录可保存！');
                return;
            }
            
            // 创建要保存的内容
            const content = document.createElement('div');
            content.style.backgroundColor = '#162447';
            content.style.padding = '20px';
            content.style.borderRadius = '12px';
            content.style.color = '#e6e6e6';
            
            let html = '<h2 style="color: #4cc9f0; text-align: center; margin-bottom: 20px;">对战记录</h2>';
            
            battleHistory.forEach((record, index) => {
                if (index < 5) { // 只保存最近5条记录
                    const teamAText = record.teamA.join(' & ');
                    const teamBText = record.teamB.join(' & ');
                    
                    html += `
                        <div style="background-color: #1f4068; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #4cc9f0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: #fca311; font-weight: 600;">
                                <span>${record.mode === '1v1' ? '1V1 对战' : '2V2 对战'}</span>
                                <span>${record.timestamp}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                <div><strong>A队：</strong> ${teamAText}</div>
                                <div><strong>B队：</strong> ${teamBText}</div>
                                <div><strong>战败方：</strong> <span style="color: #e63946;">${record.defeatedTeam}队</span></div>
                            </div>
                            ${record.note ? `<div style="margin-top: 10px; padding: 8px; background-color: #0f3460; border-radius: 4px; font-style: italic;"><strong>备注：</strong> ${record.note}</div>` : ''}
                        </div>
                    `;
                }
            });
            
            content.innerHTML = html;
            
            // 使用html2canvas将内容转换为图片
            html2canvas(content).then(canvas => {
                const link = document.createElement('a');
                link.download = `对战记录_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        // 分享到微信（模拟功能）
        function shareToWechat() {
            if (battleHistory.length === 0) {
                alert('暂无对战记录可分享！');
                return;
            }
            
            // 创建分享内容
            let shareContent = "【玩家对战记录】\n\n";
            
            // 添加最近3场对战记录
            const recentBattles = battleHistory.slice(0, 3);
            recentBattles.forEach((record, index) => {
                const teamAText = record.teamA.join(' & ');
                const teamBText = record.teamB.join(' & ');
                
                shareContent += `对战${index + 1} (${record.mode}):\n`;
                shareContent += `A队: ${teamAText}\n`;
                shareContent += `B队: ${teamBText}\n`;
                shareContent += `战败方: ${record.defeatedTeam}队\n`;
                if (record.note) {
                    shareContent += `备注: ${record.note}\n`;
                }
                shareContent += `时间: ${record.timestamp}\n\n`;
            });
            
            shareContent += "---\n";
            shareContent += "玩家对战记录系统\n";
            shareContent += "固定玩家: " + fixedPlayers.join(", ") + "\n";
            shareContent += "自定义玩家: " + customPlayers.join(", ") + "\n";
            
            // 在实际应用中，这里会调用微信分享API
            // 由于微信分享需要认证的公众号，这里使用alert模拟
            alert("分享到微信功能(模拟)\n\n分享内容已复制到剪贴板，请在微信中粘贴分享。\n\n内容预览:\n" + shareContent.substring(0, 300) + "...");
            
            // 复制到剪贴板
            navigator.clipboard.writeText(shareContent).then(() => {
                console.log("分享内容已复制到剪贴板");
            });
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('customPlayers', JSON.stringify(customPlayers));
            localStorage.setItem('battleHistory', JSON.stringify(battleHistory));
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
